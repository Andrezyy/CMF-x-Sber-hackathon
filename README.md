# CMF x Sber market hackathon

### Постановка задачи
Сбер маркет развивается и становится узнаваемым, растет ежедневное количество заказов. В связи с этим появляется потребность в прогнозировании спроса и планировании рабочих смен, чтобы лучше распоряжаться человечским ресурсом.

### Этапы задачи
1. Спрогнозировать количество заказов, по часам, на 7 дней вперед
2. Определить оптимальное количество курьеров на каждый час, чтобы вероятность опозданий была меньше 0.05
3. В соответсвии с выбраным количеством курьеров, составить оптимальное расписание из 4 - 8 часовых смен

### Исходные данные
1. orders.csv - данные по кол-ву заказов

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/orders.png)

2. patners_delays .csv - данные по кол-ву курьеров, с данной вероятность опоздать

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/patners_delays.png)



### Решение
### Работа с данным
1. Каждая зона доставки работает свое количество часов, в разное время начинает и заканчивает работать. В таблице orders есть пропуски, часы в которые не было заказов отсутсвуют. Восполним их в соотвествии с временем работы каждой зоны доставки.  Часы, в которые зоны доставок не работают, заполняться не будут, это не нарушит внутрисуточную переодичность. Также добавим некоторые признаки связанные со временем.

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/orders_modified.png)

2. Создадим таблицу work_hours в которой будет показаны время работы каждой зоны доставки, это информация пригодится на для заполнения пропусков и на 3ьем этапе.

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/work_hours.png)

3. Добавим к таблице patners_delay информацию о заказах, из дозаполенной orders и несколько признаков связанных со времнем. Информация о заказах поможет на 2ом этапе, чтобы на их основе создать новые признаки. 

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/partners_delays_modified.png)

4. Создадим таблицу daily_orders, в которой количество заказов будет не по часам а по дням. Она пригодится для 1ого этапа.

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/daily_orders.png)
    
5. Создадим тестовый набор данных, который будем заполнять 

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/test_data.png)

### I Этап
Кратко:
- Для каждой зоны доставки обучим Prophet.
- Будем учить прогнозировать общее количество заказов за день, а затем распределим их внутри дня по долям.
- Используем только 9 последних недель для обучения, так как иначе Prophet плохо справлятся.
- Зоны 2, 181, 182, 190, 195, 200, 367, 453 перестали функционировать, их предсказываем нулями.

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/dead_zone_181.png)

Последовательность действий:
1. Для ЗД #k берем данные
2. Преобразуем их box-cox
3. Обучаем Prophet
4. Делаем прогноз
5. Обратный box-cox
6. Распределяем кол-во заказов внутри дня

Подсчет долей
1. Подсчет долей от общего кол-ва заказов за день, распределение для каждой зоны доставки, каждого дня недели, по часам. Результатом будет словарь в виде словаря с ключами: (территория, день недели)
2. Внутри будет словарь вида "час работы : доля". Результат для конкретного ключа: { ... ,14: 0.08, 15: 0.09, ...}

Результат после I Этапа

    ![minipic](https://github.com/Andrezyy/CMF-x-Sber-hackathon/blob/main/Images/first_part_results.png)

